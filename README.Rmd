---
output: github_document
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
always_allow_html: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# NicheR: An R package for ellipsoid-based virtual species and niche visualization in E-space and G-space

The goal of **NicheR** is to provide a robust set of tools for researchers and modelers to:  

   - Construct and define virtual niches using ellipsoid geometries in 2D or 3D environmental dimensions.  
  - Identify and extract suitable environmental areas from various data sources (rasters, data frames).  
  - Simulate species occurrence points within suitable habitats using flexible sampling strategies (random, center-biased, or edge-biased).  
  - Visualize niche boundaries and simulated occurrences in both environmental space (E-space) and geographic space (G-space).  

Inspired by the methodologies of **NicheA** and the **virtualspecies** R package, **NicheR** streamlines niche conceptualization and data generation for ecological studies.


## Authors 

Mariana Castaneda-Guzman

Paanwaris Paansri

Connor Hughes

## Last Updated

11/14/2025

## Installation

You can install the development version of NicheR from GitHub as follows:

```{r echo =TRUE, eval = FALSE}
# 1. Install devtools if you don't have it yet
if (!require("devtools")) {
 install.packages("devtools")
}

# 2. Install bean from GitHub
devtools::install_github("castanedaM/NicheR")
```

Dependencies NicheR relies on the following R packages, which will be installed automatically with the package: dplyr, ggplot2, ggpubr,
plotly, RColorBrewer, and terra.

## Example Application

This is a basic example demonstrating the core functionality of NicheR.
Before you start, remember the distinction between what the package handles internally and what requires user input. You will need:

  1. Environmental layers (raster layers), and

  2. (Optional) a bias surface if you wish to include one.

For this example, we provide both the environmental layers and a sample bias surface.


### 1. Define Environmental Backskground 

Your environmental background, also refered to as environmental predictors, will be the base on which your virtual species will be build. 


```{r}
library(NicheR)
library(terra)
library(ggplot2)
library(ggpubr)
library(rgl)
library(plotly)


# Access example environmental raster files from the package
# Make sure "Bio1.tif", "Bio4.tif", "Bio12.tif" exist in inst/extdata
bio_1 <- terra::rast(system.file("extdata", "Bio1.tif", package = "NicheR"))
bio_4 <- terra::rast(system.file("extdata", "Bio4.tif", package = "NicheR"))
bio_12 <- terra::rast(system.file("extdata", "Bio12.tif", package = "NicheR"))

# Stack and name the environmental layers
env_stack <- c(bio_1, bio_12, bio_4)
names(env_stack) <- c("mean_temp", "temp_seasonality", "annual_precip")

# Convert the raster stack to a data frame for E-space plotting
env_df <- as.data.frame(env_stack, xy = TRUE, na.rm = TRUE)
```


### 2. Create your virtual Species

Now that the environmental background has been loaded and prepared, the next step is to define the virtual species.

In this package, you can do this in two ways:

  1. Using `create_virtual_species()`, a high-level function that creates the virtual species in a single step, or 
  2. Running each individual function separately for greater control.

Below, we demonstrate both approaches—first using the high-level function, and then showing each step individually.


#### High-Level Approach

In this step, we specify the virtual species’ niche characteristics and generate the species using create_virtual_species().

    center: defines the environmental centroid of the species’ niche (in this case, mean temperature, temperature seasonality, and annual precipitation).

    axes: controls the spread or tolerance along each environmental variable.

    angles: defines the rotation of the ellipsoid in environmental space (set to 0 for no rotation).

    env_bg: the environmental background raster stack used to project suitability.

    n_occ: number of occurrence points to sample from the suitability surface.

    out: determines which outputs are returned ("both" returns suitability and occurrences).

    distances: whether to calculate distances from the niche centroid.

    out.file: if TRUE, saves results to a file.

The resulting object includes the species’ suitability surface, sampled occurrences, and internal parameters used to generate them.


```{r}

# Define niche parameters (can also be defined in the create_virtual_species function)
niche_center <- c(mean_temp = 200,
                  temp_seasonality = 1000,
                  annual_precip = 6500)
niche_axes <- c(75, 250, 2000) 
niche_angles <- c(0, 0, 0) 



nicheR_vs <- create_virtual_species(env_bg = env_stack,
                                             center = niche_center,
                                             axes = niche_axes,
                                             angles = niche_angles,
                                             n_occ = 100,
                                             out = "both",
                                             distances = TRUE,
                                             out.file = FALSE)

```

And here are the final visuals of our virtual species. For additional visuals and customization options, see the Step-by-Step Approach section.

```{r}
plot_e_space(env_bg = env_stack,
             x = "mean_temp",
             y = "temp_seasonality",
             z = "annual_precip",
             labels = c("Mean T (°C)",
                        "Temp Seasonality", 
                        "Annual Prec (mm)"),
             niche = nicheR_vs$niche,
             palette = "default",
             show.pts.in = TRUE,
             occ_pts = nicheR_vs$occurrences)

```



```{r}

plot_g_space(env_bg = nicheR_vs$call_args$env_bg,
             niche = nicheR_vs$niche,
             show.suitable = TRUE,
             show.distance = TRUE,
             occ_pts = nicheR_vs$occurrences)
```



#### Step-by-Step Approach


##### 1. Build a 3D Ellipsoid Niche The build_ellipsoid() function creates

the core niche object by specifying its center, semi-axis lengths, and
rotation angles.

```{r}
# Define niche parameters
niche_center <- c(mean_temp = 280, temp_seasonality = 1500, annual_precip = 2000)
niche_axes <- c(100, 500, 2500) # Semi-axis lengths (breadth)
niche_angles <- c(0, 0, pi/12) # Small rotation around Z-axis

# Create the ellipsoid niche object
my_niche <- build_ellps(
  center = niche_center,
  axes = niche_axes,
  # angles = niche_angles,
  n_points = 50 # Resolution for surface points
)
```

##### 2. Visualize the Niche in Environmental Space (E-space) 

Function 'plot_e_space()' allows you to visualize e-sapce and the niche ellipsoidal boundary. 

It can generate both static 2D pairwise plots and interactive 3D plots.

##### 3. 2D Pairwise Plots

```{r, fig.width=11, fig.height=8, dpi=300, dpi=300}
plot_e_space(
  env_bg = env_df,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  labels = c("Mean T (°C)", "Temp Seasonality", "Annual Prec (mm)"),
  niche = my_niche, 
  plot.3d = F
)
```

##### 4. 3D Interactive Plot

To render a 3D interactive plot within the same plotting function as 2D, add the argument `plot.3d = TRUE`.  

The code will then generate an interactive **plotly** plot.


```{r, rgl=TRUE, eval = FALSE}

plot_e_space(
  env_bg = env_df,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  labels = c("Mean T (°C)", "Temp Seasonality", "Annual Prec (mm)"),
  niche = my_niche,
  plot.3d = TRUE # Toggle 3D plotting by setting plot.3d = TRUE
)

```

![3D plot Example](man/figures/3D.png)


### 4. Extract Suitable Environments and Sample Occurrences 

The `get_suitable_env()` function identifies all environmental points that fall within the niche.  
It includes an argument `out` that can take the values `"spatial"`, `"data.frame"`, or `"both"`.  

- `"spatial"` returns a **SpatRaster**, allowing visualization of the suitable area in geographic space (G-space).  
- `"data.frame"` returns a table of points, better suited for visualization in environmental space (E-space).  
- `"both"` returns both formats simultaneously.


```{r}
# Extract suitable environmental areas as a spatial raster
suitable_g_space <- get_suitable_env(
  niche = my_niche,
  env_bg = env_stack, # Use the raster stack for spatial output
  out = "spatial"
)

# Plot the suitable area on a map
plot_g_space(env_stack, show.suitable  = TRUE, niche = my_niche)

```


**Note:** For 3D and 2D plotting in E-space, there is no need to run the function beforehand. 

Simply toggle the argument `show.pts.in` in `plot_e_space()`, and the function will automatically calculate and plot the suitable environments.


```{r, rgl=TRUE, fig.width=11, fig.height=8, dpi=300}
# Plot in 2D
plot_e_space(
  env_bg = env_df,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  niche = my_niche,
  show.pts.in = TRUE # Change this argument to TRUE to show suitable environments
)

```


Next, let’s sample some occurrences within the suitable area.  
The function `get_sample_occ()` draws a subset of points from within the niche boundary and suitable environment.


```{r}
# Sample 500 occurrences, biased towards the center of the niche
sampled_occ_center <- get_sample_occ(
  n_occ = 500,
  niche = my_niche,
  env_bg = env_stack, # Can use raster or data.frame here
  method = "center",
  seed = 42
)

# Expand right margin so there's room for legend
plot_g_space(env_bg = env_stack, niche = my_niche,
             show.suitable = FALSE,
             occ_pts = sampled_occ_center)

```

Visualize Sampled Occurrences in Environmental Space You can integrate
these simulated occurrences back into your environmental space plots.

```{r, rgl=TRUE, fig.width=11, fig.height=8, dpi=300}
# Plot in 2D
plot_e_space(
  env_bg = env_df,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  niche = my_niche,
  occ_pts = sampled_occ_center,
  show.occ.density = TRUE # Change to remove density plots for occurrences points
)

```


Finally, we visualize all objects in one visualization.

```{r, rgl=TRUE, fig.width=11, fig.height=8, dpi=300}
# Plot in 2D
plot_e_space(
  env_bg = env_df,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  niche = my_niche,
  occ_pts = sampled_occ_center,
  show.pts.in = TRUE, # Highlight background points within niche
  show.occ.density = TRUE,
  palette = "default"# Show marginal density plots for occurrences
)

```


Try some of the other color palettes within the Package!! 

```{r echo=FALSE, rgl=TRUE}

  palettes <- list(

  default = list(
    bg           = "#9093A2FF",
    ellipsoid    = "#2A363BFF",
    centroid     = "#D72000FF",
    tolerance    = "#EE6100FF",
    suitable_env = "#FED789FF",
    occ          = "#B4BF3AFF"),

  palette2 = list(
    bg           = "#9CA9BAFF",
    ellipsoid    = "#3D619DFF",
    centroid     = "#345084FF",
    tolerance    = "#693829FF",
    suitable_env = "#CFB267FF",
    occ          = "#A56A3EFF"),


  palette3 = list(
    bg           = "#C8CCC6FF",
    ellipsoid    = "#023743FF",
    centroid     = "#72874EFF",
    tolerance    = "#476F84FF",
    suitable_env = "#FED789FF",
    occ          = "#A4BED5FF"),

  palette4 = list(
    bg           = "#C0D1CEFF",
    ellipsoid    = "#859B6CFF",
    centroid     = "#B74954FF",
    tolerance    = "#A99364FF",
    suitable_env = "#C2DDB2FF",
    occ          = "#EBA49EFF"),

  palette5 = list(
    bg           = "#A89F8EFF",
    ellipsoid    = "#7887A4FF",
    centroid     = "#A8CDECFF",
    tolerance    = "#682C37FF",
    suitable_env = "#F6955EFF",
    occ          = "#9B6981FF"),


  palette6 = list(
    bg           = "#D3D4D8FF",
    ellipsoid    = "#731A12FF",
    centroid     = "#F2D43DFF",
    tolerance    = "#3F858CFF",
    suitable_env = "#D9814EFF",
    occ          = "#707322FF")

  )

df <- do.call(rbind, lapply(names(palettes), function(pname) {
  data.frame(
    palette = pname,
    role    = factor(names(palettes[[pname]]), 
                     levels = c("bg", "ellipsoid", "centroid",
                                "tolerance", "suitable_env", "occ")),
                     color   = unlist(palettes[[pname]]),
                     stringsAsFactors = FALSE
    )
}))

ggplot(df, aes(x = role, y = palette, fill = color)) +
  geom_tile(color = "white", linewidth = 0.5) +
  geom_text(aes(label = color), color = "white", size = 3.5) +
  scale_fill_identity() +
  theme_minimal() +
  labs(x = NULL, y = NULL, title = "Palette comparison") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )

```

Example: Palette 4

```{r echo = FALSE, fig.width=11, fig.height=8, dpi=300}
plot_e_space(
  env_bg = env_df,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  niche = my_niche,
  show.pts.in = TRUE, # Highlight background points within niche
  occ_pts = sampled_occ_center,
  show.occ.density = TRUE,
  palette = "palette4"# Show marginal density plots for occurrences
)
```

Example: Palette 6 

```{r, echo = FALSE, fig.width=11, fig.height=8, dpi=300}
plot_e_space(
  env_bg = env_df,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  niche = my_niche,
  show.pts.in = TRUE, # Highlight background points within niche
  occ_pts = sampled_occ_center,
  show.occ.density = TRUE,
  palette = "palette6"# Show marginal density plots for occurrences
)

```


Don’t like these palettes? Provide your own! Use the colors argument with a list of hex codes. If colors are unnamed, they will be assigned in order: bg (background), ellipsoid, centroid, tolerance (axis ranges), suitable_env (environment inside ellipsoid), and occ (occurrence records). Best practice is to use named values, for example:

```{r, fig.width=11, fig.height=8, dpi=300}
plot_e_space(
  env_bg = env_df,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  niche = my_niche,
  show.pts.in = TRUE,
  occ_pts = sampled_occ_center,
  show.occ.density = TRUE,
  colors = list(bg = "lightgrey",
                ellipsoid = "lightblue", 
                centroid = "#FF6347", 
                tolerance = "orange",
                suitable_env = "#EEEE00",
                occ = "purple4")
  )

```

**Note**: for 3D plotting is better to provide the HEX color codes! 

Want to save your plot in high resolution, publication-ready format? Below is an example of how to save it as a TIFF with recommended sizing for 2D plots.

```{r echo=TRUE, eval=FALSE}

tiff(filename = "NicheR_plot2D.tiff", width = 11, height = 8, 
     units = "in", res = 300, compression = "lzw")

plot_e_space(
  env_bg = env_df,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  labels = c("Mean T (°C)", "Temp Seasonality", "Annual Prec (mm)"),
  niche = my_niche,
  show.pts.in = TRUE, 
  occ_pts = sampled_occ_center,
  show.occ.density = TRUE,
  palette = "palette3"
)

dev.off()

```

# Apply Bias Surface

```{r}
sp_rich <- terra::rast(system.file("extdata", "sr_sp_host_0.05.tif", package = "NicheR"))
nighttime <- terra::rast(system.file("extdata", "nighttime.tif", package = "NicheR"))
Bias <- apply_bias_surface(bias_surface = c(sp_rich, nighttime), 
                             bias_direction = c(1, -1), 
                             ecological_suitability = suitable_g_space)
```


### Contributing 
We welcome contributions! If you have suggestions, bug
reports, or would like to contribute code, please feel free to open an
issue or submit a pull request on the NicheR GitHub repository.
